#!/command/with-contenv bashio
ROOT=/data
DATA_ROOT=/data/data
CONFIG_ROOT=/config

DATA_ROOT=/data/db
NEW_INSTALL=false

if ! bashio::fs.directory_exists "${DATA_ROOT}"; then
    NEW_INSTALL=true
fi

bashio::config.has_value 'domain' && DOMAIN=$(bashio::config 'domain') && bashio::log.info 'Domain set'

# Save variables
echo -n "${DATA_ROOT}" > /var/run/s6/container_environment/DATA_ROOT
echo -n "${NEW_INSTALL}" > /var/run/s6/container_environment/NEW_INSTALL
echo -n "${DOMAIN}" > /var/run/s6/container_environment/DOMAIN

# Create folders
mkdir -p "${DATA_ROOT}"

# Copy Templates if not exists
if [ -d /config ]; then
    if [ ! -d /config/addons/vocechat/ ]; then
        mkdir -p /config/addons/vocechat/
        cp -f /etc/vocechat/templates/login_by_email.html /config/addons/vocechat
    fi
fi

# Redirect log output
rm -f "${ROOT}/app.err"
ln -s /proc/1/fd/1 "${ROOT}/app.err"
